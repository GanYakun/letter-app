<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>ç™»å½• - Letter</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Helvetica Neue", sans-serif;
      overflow-y: hidden;
      /* å»æ‰å‚ç›´æ»šåŠ¨æ¡ */
    }

    .login-container {
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: white;
    }

    .login-box {
      width: 100%;
      height: 100%;
      padding: 24px;
      background-color: white;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      text-align: center;
    }

    .login-box h2 {
      margin-bottom: 20px;
      color: #333;
    }

    .login-box input {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .login-box button {
      width: 90%;
      padding: 10px;
      background-color: #00bfa5;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .login-box button:hover {
      background-color: #009688;
    }

    .switch-mode {
      margin-top: 15px;
      font-size: 14px;
      color: #00bfa5;
      cursor: pointer;
    }

    .avatar-preview {

      width: 80px;
      height: 80px;
      margin: 0 auto 20px auto;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .login-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>

<body>
  <div id="login" class="login-container">
    <div class="login-box">
      <!-- ç™»å½•è¡¨å• -->
      <div v-if="mode === 'login'" style="padding-top: 25px;">
        <!-- <h3>æ¬¢è¿å›æ¥</h3> -->

        <!-- æ–°å¢ï¼šç”¨æˆ·å¤´åƒ -->
        <div class="avatar-preview">
          <img :src="avatarUrl" alt="ç”¨æˆ·å¤´åƒ" class="login-avatar" />
        </div>

        <input type="text" v-model="username" placeholder="è´¦å·" autofocus @blur="onUsernameBlur" />
        <input type="password" v-model="password" placeholder="å¯†ç " @keyup.enter="login" />
        <button @click="login">ç™»å½•</button>
        <div class="switch-mode" @click="toggleMode">æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</div>
      </div>

      <!-- æ³¨å†Œè¡¨å• -->
      <div v-else>
        <h2>æ¬¢è¿æ³¨å†Œ</h2>
        <input type="text" v-model="newUsername" placeholder="è¯·è¾“å…¥è´¦å·" autofocus />
        <input type="password" v-model="newPassword" placeholder="è¯·è¾“å…¥å¯†ç " />
        <input type="password" v-model="confirmPassword" placeholder="ç¡®è®¤å¯†ç " @keyup.enter="register" />
        <button @click="register">ä¸‹ä¸€æ­¥</button>
        <div class="switch-mode" @click="toggleMode">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</div>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥ Vue å’Œ ipcRenderer -->
  <script src="../../vue.js"></script>
  <script src="../../../node_modules/axios/dist/axios.min.js"></script>
  <script>
    new Vue({
      el: '#login',
      data: {
        mode: 'login', // login / register
        username: '',
        password: '',
        newUsername: '',
        newPassword: '',
        confirmPassword: '',
        avatarUrl: '../../../renderer/assets/defualtAvatar.png'
      },
      methods: {
        onUsernameBlur(e) {
          let url = 'http://localhost:8083/auth/party/photo/' + e.target.value;
          axios.get(url, { responseType: 'blob' })
            .then((res) => {
              if (res.status === 200) {
                const imageUrl = URL.createObjectURL(res.data); // åˆ›å»ºä¸´æ—¶å¯¹è±¡ URL
                this.avatarUrl = imageUrl; // æ›´æ–°å¤´åƒè·¯å¾„
              } else {
                this.avatarUrl = '../../../renderer/assets/defualtAvatar.png';
              }
            });
        },
        toggleMode() {
          this.mode = this.mode === 'login' ? 'register' : 'login';
        },
        login() {
          try {
            const socket = new WebSocket('ws://localhost:8083/auth/ws');
            const stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
              stompClient.send(
                "/app/chat",
                {
                  'content-type': 'application/json'
                },
                JSON.stringify({ "content": "æµ‹è¯•æ¶ˆæ¯" })
              );
            });
          } catch (e) {
            console.error("ğŸš« æ— æ³•åˆ›å»º WebSocket å®ä¾‹", e);
          }
          // if (this.username && this.password) {
          //   axios({
          //     method: 'post',
          //     url: 'http://localhost:8083/auth/login',
          //     headers: {
          //       'Content-Type': 'application/x-www-form-urlencoded'
          //     },
          //     data: {
          //       username: this.username,
          //       password: this.password,
          //     }
          //   }).then((res) => {
          //     console.log("res", res)
          //     if (res.data.code === 200) {
          //       alert('ç™»å½•æˆåŠŸ');

          // window.electronAPI.loginSuccess(this.username)
          //     } else {
          //       alert('ç™»å½•å¤±è´¥');
          //     }
          //   })

          // } else {
          //   alert('è¯·è¾“å…¥ç”¨è´¦å·å’Œå¯†ç ');
          // }
        },
        register() {
          if (!this.newUsername || !this.newPassword || !this.confirmPassword) {
            alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
            return;
          }

          if (this.newPassword !== this.confirmPassword) {
            alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            return;
          }

          axios({
            method: 'post',
            url: 'http://localhost:8083/auth/user/add',
            headers: {
              'Content-Type': 'application/json'
            },
            data: {
              userLoginId: this.newUsername,
              currentPassword: this.newPassword,
            }

          }).then((res) => {
            console.log("res", res)
            if (res.data.code === 200) {
              // alert('æ³¨å†ŒæˆåŠŸ');
              window.location.href = './profile.html?username=' + this.newUsername; // Redirect to profile page
              this.mode = 'login';
            } else {
              alert('æ³¨å†Œå¤±è´¥');
            }
          })
        }
      }
    });
  </script>
</body>

</html>